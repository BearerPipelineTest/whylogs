syntax = "proto3";

import "google/protobuf/struct.proto";
import "google/protobuf/wrappers.proto";

option java_package = "com.whylogs.core.message";
option java_outer_classname = "Messages";
option java_multiple_files = true;

message InferredType {
  enum Type {
    UNKNOWN = 0;
    NULL = 1;
    FRACTIONAL = 2;
    INTEGRAL = 3;
    BOOLEAN = 4;
    STRING = 5;
  }

  Type type = 1;
  double ratio = 2;
}

message DoublesMessage {
  int64 count = 1;
  double min = 2;
  double max = 3;
  double sum = 4;
}

message LongsMessage {
  int64 count = 1;
  int64 min = 2;
  int64 max = 3;
  int64 sum = 4;
}

message VarianceMessage {
  int64 count = 1;
  double sum = 2; // sample variance * (n-1)
  double mean = 3;
}

message HllSketchMessage {
  bytes sketch = 1;
  int32 lg_k = 2;
}

message FrequentItemsSketchMessage {
  bytes sketch = 1;
  int32 lg_max_k = 2;
}

message NumbersMessage {
  VarianceMessage variance = 1;
  oneof numbers {
    DoublesMessage doubles = 2;
    LongsMessage longs = 3;
  }

  // sketches
  bytes histogram = 4;
  bytes theta = 5;
  bytes compact_theta = 6;
}

message StringsMessage {
  int64 count = 1;

  // sketches
  bytes theta = 2;
  bytes items = 3;
  bytes compact_theta = 4;
  NumbersMessage length = 5;
  NumbersMessage token_length = 6;
}

message SchemaMessage {
  map<int32, int64> typeCounts = 1;
  InferredType inferred_type = 2;
}

message TrackerMap {
  enum Type {
    UNKNOWN = 0;
    n = 1;
    d = 2;
    serialized_bytes = 3;
    schema = 4;
    numbers = 5;
    strings = 6;
    inferred_type = 7;
    frequent_items = 8;
    cardinality_tracker = 9;
    custom = 99;
  }
}

message TrackerMessage {
  string name = 1;
  int32 type_index = 2;
  oneof value {
    int64 n = 3;
    double d = 4;
    bytes serialized_bytes = 5;
    SchemaMessage schema = 6;
    NumbersMessage numbers = 7;
    StringsMessage strings = 8;
    InferredType inferred_type = 9;
    FrequentItemsSketchMessage frequent_items = 10;
    HllSketchMessage cardinality_tracker = 11;

    PluginMessage custom = 99;
  }
}

message PluginType {
  enum Language {
    PYTHON = 0;
    JAVA = 1;
  }
  string plugin_class_name = 1;
  Language language = 2;
}

message PluginMessage {
  string name = 1;
  repeated PluginType plugin_types = 2; // The language and corresponding classname that implements this plugin.
  oneof item {
    google.protobuf.Struct params = 3;
    bytes serialized_bytes = 4;
  }
}

message ColumnMessage {
  string name = 1;
  map<string, TrackerMessage> trackers = 2;
}

message DatasetProperties {
  uint32 schema_major_version = 1;
  uint32 schema_minor_version = 2;

  string session_id = 3;
  int64 session_timestamp = 4;
  int64 data_timestamp = 5;
  map<string, string> tags = 6;
  map<string, string> metadata = 7;
}

message DatasetProfileMessage {
  DatasetProperties properties = 1;
  map<string, ColumnMessage> columns = 2;
  map<string, PluginMessage> metric_plugins = 3;
}
